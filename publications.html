<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocular-Motor lab - Publications</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Load Shared Tailwind Configuration -->
    <script src="tailwind-config.js"></script>
    <!-- Import Navigation Logic -->
    <script src="nav.js"></script>
</head>

<body class="bg-gray-100 min-h-screen font-sans antialiased">

    <!-- The Navigation Menu will be dynamically inserted here by nav.js -->

    <main id="main-content" class="max-w-7xl mx-auto pt-19 pb-12 px-4 sm:px-6 lg:px-8" role="main">
        <header class="sr-only">
            <h1>Publications</h1>
        </header>

        <div id="publications-container" class="space-y-6">
            <div id="loading-indicator" class="text-center py-10 text-gray-500" aria-live="polite" aria-busy="true">
                <svg class="animate-spin h-8 w-8 text-accent-text mx-auto" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 24 24" aria-hidden="true">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <p class="mt-2">Loading publicationsâ€¦</p>
            </div>

            <section id="error-message"
                class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative shadow-lifted"
                role="alert" aria-live="assertive">
                <strong class="font-bold">Error loading data!</strong>
                <span class="block sm:inline" id="error-details"></span>
                <p class="mt-2 text-sm">Please ensure the CSV file is named <code
                        class="font-mono">publications.csv</code> and is in the same directory as this page.</p>
            </section>

            <!-- Search & Filter Panel -->
            <section id="filter-panel" class="hidden bg-white p-5 rounded shadow-md border border-gray-200"
                aria-label="Filter publications">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <div>
                        <label for="filter-type" class="block text-sm font-semibold text-gray-700 mb-2">Publication
                            Type</label>
                        <select id="filter-type"
                            class="w-full p-2.5 border border-gray-300 rounded focus:ring-accent-blue focus:border-accent-blue bg-gray-50 text-gray-900 text-sm">
                            <option value="all">All Types</option>
                        </select>
                    </div>

                    <div>
                        <label for="filter-year" class="block text-sm font-semibold text-gray-700 mb-2">Year</label>
                        <select id="filter-year"
                            class="w-full p-2.5 border border-gray-300 rounded focus:ring-accent-blue focus:border-accent-blue bg-gray-50 text-gray-900 text-sm">
                            <option value="all">All Years</option>
                        </select>
                    </div>

                    <div>
                        <label for="filter-category" class="block text-sm font-semibold text-gray-700 mb-2">Research
                            Category</label>
                        <select id="filter-category"
                            class="w-full p-2.5 border border-gray-300 rounded focus:ring-accent-blue focus:border-accent-blue bg-gray-50 text-gray-900 text-sm">
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                </div>

                <div class="mt-3 text-right text-sm text-gray-500" aria-live="polite">
                    Showing <span id="visible-count" class="font-bold text-gray-900">0</span>
                    of <span id="total-count">0</span> publications
                </div>
                <div
                    class="mt-4 pt-3 border-t border-gray-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 text-sm text-gray-600">

                    <!-- Left: pill link -->
                    <!-- <a href="justforfun.html" class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold
                            bg-accent-blue/10 text-accent-text border border-accent-blue/30
                            hover:bg-accent-blue hover:text-black transition-colors
                            focus:outline-none focus:ring-2 focus:ring-accent-blue focus:ring-offset-2">
                        Just for fun
                    </a> -->

                    <!-- Right: accessibility notice -->
                    <p>
                        If you have issues accessing any publication, please contact
                        <a href="mailto:jom@berkeley.edu" class="text-accent-text font-semibold hover:underline
                              focus:outline-none focus:ring-2 focus:ring-accent-blue focus:ring-offset-2 rounded-sm">
                            jom@berkeley.edu
                        </a>
                    </p>

                </div>
            </section>

            <!-- Publications List -->
            <div id="publication-list" class="space-y-4" role="list" aria-label="Publication list"></div>
        </div>
    </main>

    <script>
        let allPublications = [];

        const ui = {
            loading: document.getElementById('loading-indicator'),
            error: document.getElementById('error-message'),
            errorDetails: document.getElementById('error-details'),
            publicationList: document.getElementById('publication-list'),
            filterPanel: document.getElementById('filter-panel'),
            filterType: document.getElementById('filter-type'),
            filterYear: document.getElementById('filter-year'),
            filterCategory: document.getElementById('filter-category'),
            visibleCount: document.getElementById('visible-count'),
            totalCount: document.getElementById('total-count')
        };

        function cleanStr(v) {
            return (v ?? '').toString().trim();
        }

        // New function to remove content in parentheses and reorder "Last, First" to "First Last"
        function cleanAuthors(v) {
            let s = cleanStr(v);
            if (!s) return '';

            // Regex to find "Last, First" patterns, counting for optional "(Notion Link)"
            // Group 1: Last Name
            // Group 2: First Name
            const regex = /([^,]+),\s*([^,(]+)(?:\s*\([^)]*\))?(?:,\s*|$)/g;

            let authors = [];
            let match;
            let hasMatch = false;

            while ((match = regex.exec(s)) !== null) {
                hasMatch = true;
                let last = match[1].trim();
                let first = match[2].trim();
                authors.push(`${first} ${last}`);
            }

            // Fallback: If no "Last, First" pattern found (e.g. single name or different format),
            // just remove the parentheses and return.
            if (!hasMatch) {
                return s.replace(/\s*\([^)]*\)/g, '');
            }

            return authors.join(', ');
        }

        function parseCategoryList(raw) {
            const s = cleanStr(raw);
            if (!s) return [];
            const parts = s.split(',').map(x => x.trim()).filter(Boolean);
            return Array.from(new Set(parts));
        }

        function parseCSV(csvText) {
            const results = Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true
            });

            if (results.errors?.length) {
                console.warn("CSV Parsing Errors:", results.errors);
            }

            return results.data.map(row => ({
                type: cleanStr(row.Type) || 'Other',
                title: cleanStr(row.Title) || 'Untitled Publication',
                authors: cleanStr(row['Authors text2']), // Use cleaned authors
                journal: cleanStr(row['Journal full name']),
                year: cleanStr(row.Year),
                categories: parseCategoryList(row['Broad Topic']),
                link_paper: cleanStr(row.PDF) ? `pubs/${cleanStr(row.PDF)}` : null,
                link_abstract: cleanStr(row.Link),
                link_poster: null,
                link_datacode: null,
                link_data: null,
                link_code: null,
                description: cleanStr(row.Abstract)
            })).filter(pub => pub.year); // Filter out rows with empty year
        }


        function setLoading(isLoading) {
            ui.loading.classList.toggle('hidden', !isLoading);
            ui.loading.setAttribute('aria-busy', String(isLoading));
        }

        function runApp(csvText) {
            setLoading(false);
            ui.error.classList.add('hidden');

            allPublications = parseCSV(csvText);

            if (!allPublications.length) {
                ui.publicationList.innerHTML = '<p class="text-gray-500 italic text-center">No publications found in the data.</p>';
                return;
            }

            // Sort by year descending (handling potential non-numeric years gracefully)
            allPublications.sort((a, b) => (parseInt(b.year) || 0) - (parseInt(a.year) || 0));

            populateFilters();
            ui.filterPanel.classList.remove('hidden');
            filterAndRender();
        }

        function populateFilters() {
            const types = new Set();
            const years = new Set();
            const categories = new Set();

            allPublications.forEach(pub => {
                if (pub.type) types.add(pub.type);
                if (pub.year) years.add(pub.year);
                (pub.categories || []).forEach(c => categories.add(c));
            });

            const addOptions = (selectEl, items, sortDesc = false) => {
                const sorted = Array.from(items).sort((a, b) => a.localeCompare(b));
                if (sortDesc) sorted.reverse();
                sorted.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item;
                    opt.textContent = item;
                    selectEl.appendChild(opt);
                });
            };

            ui.filterType.innerHTML = '<option value="all">All Types</option>';
            ui.filterYear.innerHTML = '<option value="all">All Years</option>';
            ui.filterCategory.innerHTML = '<option value="all">All Categories</option>';

            addOptions(ui.filterType, types);
            addOptions(ui.filterYear, years, true);
            addOptions(ui.filterCategory, categories);

            ui.filterType.addEventListener('change', filterAndRender);
            ui.filterYear.addEventListener('change', filterAndRender);
            ui.filterCategory.addEventListener('change', filterAndRender);
        }

        function filterAndRender() {
            const selectedType = ui.filterType.value;
            const selectedYear = ui.filterYear.value;
            const selectedCategory = ui.filterCategory.value;

            const filtered = allPublications.filter(pub => {
                const matchType = selectedType === 'all' || pub.type === selectedType;
                const matchYear = selectedYear === 'all' || pub.year === selectedYear;
                const matchCategory = selectedCategory === 'all' || (pub.categories || []).includes(selectedCategory);
                return matchType && matchYear && matchCategory;
            });

            ui.visibleCount.textContent = String(filtered.length);
            ui.totalCount.textContent = String(allPublications.length);

            if (!filtered.length) {
                ui.publicationList.innerHTML =
                    '<div class="text-center py-8 text-gray-500 bg-white rounded border border-gray-200">No publications match your filters.</div>';
                return;
            }

            ui.publicationList.innerHTML = filtered.map((p, i) => renderPublicationCard(p, i)).join('');
        }

        function linkBtn(url, label, iconSvg, pubTitle) {
            if (!url) return '';
            const safeLabel = `${label} for ${pubTitle}`;
            return `
              <a href="${url}" target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center px-2.5 py-1.5 text-xs font-semibold text-accent-text bg-blue-50 border border-accent-blue/25 rounded-full hover:bg-accent-blue hover:text-black transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-accent-blue focus:ring-offset-2"
                 aria-label="${safeLabel}">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                     class="mr-1.5" aria-hidden="true">${iconSvg}</svg>
                <span aria-hidden="true">${label}</span>
              </a>`;
        }

        function renderCategoryPills(categories) {
            if (!categories?.length) return '';
            return categories.map(c => `
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold
                         bg-teal-100 text-teal-800 border border-teal-300">
              ${c}
            </span>`).join('');
        }

        function renderPublicationCard(pub, idx) {
            const id = `pub-${idx}`;
            const yearLabel = pub.year ? `Publication year ${pub.year}` : 'Publication year';

            // Pastel rainbow colors (reduced palette of 7, high contrast order)
            const yearColors = [
                'bg-red-100 text-red-800 border-red-200',       // Warm
                'bg-teal-100 text-teal-800 border-teal-200',    // Cool
                'bg-amber-100 text-amber-800 border-amber-200', // Warm
                'bg-blue-100 text-blue-800 border-blue-200',    // Cool
                'bg-orange-100 text-orange-800 border-orange-200', // Warm
                'bg-purple-100 text-purple-800 border-purple-200', // Cool
                'bg-emerald-100 text-emerald-800 border-emerald-200' // Cool/Green (distinct from Red)
            ];

            // Pick color based on year
            const yearNum = parseInt(pub.year) || 0;
            const colorClass = yearColors[yearNum % yearColors.length] || 'bg-gray-100 text-gray-600 border-gray-200';

            const ICON_PDF = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>';
            const ICON_CODE = '<polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline>';
            const ICON_LINK = '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.74 1.74"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>';

            // Only show buttons for links that exist
            const linksHtml =
                linkBtn(pub.link_paper, 'PDF', ICON_PDF, pub.title) +
                linkBtn(pub.link_abstract, 'Link', ICON_LINK, pub.title);

            // Collapsible description using line-clamp
            const descriptionHtml = pub.description
                ? `<div class="mt-3 text-sm text-gray-700 bg-gray-50 p-3 rounded border border-gray-100 cursor-pointer group"
                        onclick="this.querySelector('p').classList.toggle('line-clamp-1'); this.querySelector('p').classList.toggle('text-gray-900');"
                        title="Click to expand/collapse">
                   <p class="line-clamp-1 transition-all duration-200">
                     <span class="font-semibold text-gray-800">Summary:</span> ${pub.description}
                   </p>
                 </div>`
                : '';

            const categoriesHtml = renderCategoryPills(pub.categories);

            return `
              <article role="listitem"
                       class="bg-white p-4 sm:p-5 rounded shadow-lifted border border-gray-200 hover:shadow-xl transition-shadow duration-300"
                       aria-labelledby="${id}-title">
                <div class="flex items-start justify-between gap-3">
                  <h2 id="${id}-title" class="text-lg sm:text-xl font-bold text-gray-900 leading-snug">
                    ${pub.title}
                  </h2>
                  ${pub.year ? `
                    <span class="inline-flex items-center px-2 py-1 text-[14px] font-bold ${colorClass} rounded uppercase tracking-wide whitespace-nowrap flex-shrink-0 border"
                          aria-label="${yearLabel}">
                      ${pub.year}
                    </span>` : ''}
                </div>

                ${pub.authors ? `<p class="text-gray-700 text-sm mt-1  border-l-2 border-accent-gray pl-2">${pub.authors}</p>` : ''}

                ${(pub.journal || linksHtml) ? `
                <div class="flex flex-wrap items-center gap-3 mt-1" aria-label="Publication meta">
                    ${pub.journal ? `
                    <span class="text-gray-500 text-sm italic border-l-2 border-accent-blue pl-2">
                        ${pub.journal}
                    </span>` : ''}
                    ${linksHtml ? `
                    <span class="flex flex-wrap gap-2">
                        ${linksHtml}
                    </span>` : ''}
                </div>
                ` : ''}

                ${descriptionHtml}

                <div class="mt-3 pt-3 border-t border-gray-100 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                  <div class="flex flex-wrap gap-1.5" aria-label="Research categories">
                    ${categoriesHtml || '<span class="text-xs text-gray-500">Uncategorized</span>'}
                  </div>
                  <span class="text-[11px] text-gray-500 uppercase font-semibold tracking-wider">
                    ${pub.type}
                  </span>
                </div>
              </article>`;
        }

        function init() {
            renderNavigation('publications.html');
            setLoading(true);

            fetch('publications.csv')
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP error! Status: ${r.status}`);
                    return r.text();
                })
                .then(runApp)
                .catch(err => {
                    console.error("Load Error:", err);
                    setLoading(false);
                    ui.error.classList.remove('hidden');
                    ui.errorDetails.textContent = ` Could not fetch publications.csv. Details: ${err.message}`;
                });
        }

        window.addEventListener('load', init);
    </script>
</body>

</html>